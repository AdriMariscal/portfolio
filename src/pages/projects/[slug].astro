---
// src/pages/projects/[slug].astro
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";

export async function getStaticPaths() {
  const entries = await getCollection("projects", ({ data }) => data.published !== false);
  return entries.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const project = await getEntry("projects", slug);
if (!project) throw new Error(`Proyecto no encontrado: ${slug}`);

const { Content } = await project.render();
const data: any = project.data;

// utils
const fmtDate = (d: Date | string | undefined) => {
  if (!d) return undefined;
  try {
    const dd = typeof d === "string" ? new Date(d) : d;
    return dd.toLocaleDateString("es-ES", { day: "2-digit", month: "long", year: "numeric" });
  } catch { return String(d); }
};

// normaliza urls: null/"" => undefined
const normalizeUrl = (v: unknown) =>
  typeof v === "string" && v.trim() !== "" ? v : undefined;

// campos
const title: string = data.title;
const tags: string[] = Array.isArray(data.tags) ? data.tags : [];

const projectUrl = normalizeUrl(data.projectUrl);
const repoUrl = normalizeUrl(data.repoUrl);
const demoUrl = normalizeUrl(data.demoUrl);

// estado
const isActive: boolean =
  typeof data.active === "boolean"
    ? data.active
    : typeof data.status === "string"
      ? ["active", "activo", "activa"].includes(String(data.status).toLowerCase())
      : data.published !== false;

// changelog
type Change = { type?: string; text?: string };
type Release = { version?: string; date?: string; changes?: Change[] };
const changelog: Release[] = Array.isArray(data.changelog) ? data.changelog : [];
const latest = changelog.length ? changelog[0] : undefined;
const latestDate = latest?.date ? fmtDate(latest.date) : undefined;
---

<BaseLayout title={title} description={undefined}>
  <article class="section post">
    <!-- margen inferior ajustado a 24px -->
    <div class="wrap post__card card card--soft" style="margin:8px auto 24px">
      <div class="post__body">
          <h1 class="post__title">{title}</h1>

            <p class="post__date">
          <strong>Estado:</strong> {isActive ? "Activo" : "Inactivo"}
          {latest?.version && (
              <>
              {" · "}<strong>Última versión:</strong> {latest.version}
                {latestDate && ` (${latestDate})`}
              </>
            )}
            </p>

          {(projectUrl || repoUrl || demoUrl) && (
          <div class="post__actions" style="display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0 0">
          {projectUrl && (
              <a class="btn btn--secondary btn--sm" href={projectUrl} target="_blank" rel="noopener noreferrer">
                Ver proyecto →
            </a>
            )}
            {repoUrl && (
              <a class="btn btn--secondary btn--sm" href={repoUrl} target="_blank" rel="noopener noreferrer">
                Ver código
              </a>
            )}
            {demoUrl && (
              <a class="btn btn--secondary btn--sm" href={demoUrl} target="_blank" rel="noopener noreferrer">
                Ver demo
              </a>
          )}
          </div>
          )}

        <div class="post__prose">
          <Content />
        </div>

        {tags?.length ? (
          <footer class="post__meta">
            <ul class="tags tags--sm tags--mt" aria-label="Tecnologías del proyecto">
              {tags.map((t) => (
                <li>
                  <a class="tag" href={`/blog/tags/${encodeURIComponent(t)}/`}>#{t}</a>
                </li>
              ))}
          </ul>
          </footer>
        ) : null}
      </div>
    </div>
  </article>

  {/* Changelog con sección compacta y respiración inferior */}
  {changelog.length ? (
    <article class="section section--tight post" style="padding-bottom:24px">
      <div class="wrap" aria-labelledby="changelog-title">
            <h2 id="changelog-title" class="h3" style="margin:0 0 .75rem">Changelog</h2>

            {changelog.map((rel, i) => {
            const d = fmtDate(rel?.date);
              return (
              <article class="card card--soft" style={i > 0 ? "margin-top: 1rem" : undefined}>
                  <div class="card__body">
                    <h3 class="h4" style="margin:0 0 .5rem">
                    {rel?.version}{d && ` (${d})`}
              </h3>
                  {Array.isArray(rel?.changes) && rel!.changes!.length ? (
                      <ul>
                      {rel!.changes!.map((c) => (
                  <li>
                          {c?.type ? <><strong>{c.type}</strong>{c?.text ? " " : ""}</> : null}
                            {c?.text}
                  </li>
                ))}
              </ul>
                  ) : null}
                  </div>
                </article>
              );
            })}
          </div>
    </article>
  ) : null}
</BaseLayout>
