---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects", ({ data }) => data.published !== false);
  return projects.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing slug");

const entry = await getEntryBySlug("projects", slug);
if (!entry) throw new Error(`Proyecto no encontrado: ${slug}`);

const { Content } = await entry.render();
const data = entry.data;

const latest = data.changelog?.[0];
const latestVersion = latest?.version ?? null;
const lastUpdate = latest?.date ?? data.date;

function fmt(d: Date | string) {
  try { return new Date(d).toLocaleDateString("es-ES"); } catch { return String(d); }
}
---

<BaseLayout title={`${data.title} · Proyecto`} description={data.description}>
  <section class="section">
    <div class="container">

      <article class="card">
        <div class="card__body">
          <h1 style="margin-bottom:.5rem">{data.title}</h1>

          <p style="margin:.25rem 0 1rem; color:var(--am-graphite,#162433); font-size:.95rem">
            <strong>Estado:</strong> {data.status}
            {latestVersion ? ` · ` : ""}
            {latestVersion ? <><strong>Última versión:</strong> {latestVersion} <small>({fmt(lastUpdate)})</small></> : null}
          </p>

          {(data.repoUrl || data.demoUrl) && (
            <p style="margin:.25rem 0 1rem">
              {data.repoUrl && <a class="link" href={data.repoUrl} target="_blank" rel="noopener noreferrer">Código</a>}
              {data.repoUrl && data.demoUrl && " · "}
              {data.demoUrl && <a class="link" href={data.demoUrl} target="_blank" rel="noopener noreferrer">Demo</a>}
            </p>
          )}

          {data.tags?.length ? (
            <p style="margin:.25rem 0 1rem"><strong>Tecnologías:</strong> {data.tags.join(", ")}</p>
          ) : null}

          <hr style="border:none; border-top:1px solid #E2E8F0; margin:12px 0" />

          {/* Cuerpo del proyecto en Markdown */}
          <Content />
        </div>
      </article>

      {data.changelog?.length ? (
        <section class="section" style="padding-top:24px">
          <h2>Changelog</h2>
          <ul class="stack">
            {data.changelog.map((rel) => (
              <li class="card">
                <div class="card__body">
                  <div class="card__title">
                    {rel.version} <span style="font-size:.9rem; color:#6b7280">({fmt(rel.date)})</span>
                  </div>
                  <ul style="margin-top:.5rem; padding-left:1.25rem">
                    {rel.changes.map((c) => (
                      <li><code>{c.type}</code> {c.text}</li>
                    ))}
                  </ul>
                </div>
              </li>
            ))}
          </ul>
        </section>
      ) : null}

    </div>
  </section>
</BaseLayout>
