---
// src/pages/projects/[slug].astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects", ({ data }) => data.published !== false);
  return projects.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing slug");

const entry = await getEntryBySlug("projects", slug);
if (!entry) throw new Error(`Proyecto no encontrado: ${slug}`);

const { Content } = await entry.render();
const data = entry.data;

const latest = data.changelog?.[0];
const latestVersion = latest?.version ?? null;
const lastUpdate = latest?.date ?? data.date;

function fmt(d: Date | string) {
  try { return new Date(d).toLocaleDateString("es-ES"); } catch { return String(d); }
}

// Asegura que cualquier URL sin protocolo sea absoluta (https://)
function ensureAbs(url?: string) {
  if (!url) return undefined;
  return /^https?:\/\//i.test(url) ? url : `https://${url}`;
}
---

<BaseLayout title={`${data.title} · Proyecto`} description={data.description}>
  <section class="section">
    <div class="wrap">
      <article class="card">
        <div class="card__body">
          <h1 class="card__title" style="margin-bottom:.5rem">{data.title}</h1>

          <p style="margin:.25rem 0 1rem; color:var(--am-graphite,#162433); font-size:.95rem">
            <strong>Estado:</strong> {data.status}
            {latestVersion ? ` · ` : ""}
            {latestVersion ? <><strong>Última versión:</strong> {latestVersion} <small>({fmt(lastUpdate)})</small></> : null}
          </p>

          {(data.projectUrl || data.repoUrl || data.demoUrl) && (
            <div class="project__links">
              {data.projectUrl && (
                <a
                  class="btn btn--secondary btn--sm"
                  href={ensureAbs(data.projectUrl)}
                  target="_blank"
                  rel="noopener noreferrer"
                  title="Abrir proyecto en una nueva pestaña"
                  aria-label="Abrir proyecto en una nueva pestaña"
                >Ver proyecto ↗</a>
              )}

              {data.repoUrl && (
                <a
                  class="btn btn--secondary btn--sm"
                  href={ensureAbs(data.repoUrl)}
                  target="_blank"
                  rel="noopener noreferrer"
                  title="Abrir repositorio en una nueva pestaña"
                  aria-label="Abrir repositorio en una nueva pestaña"
                >Código ↗</a>
              )}

              {data.demoUrl && (
                <a
                  class="btn btn--secondary btn--sm"
                  href={ensureAbs(data.demoUrl)}
                  target="_blank"
                  rel="noopener noreferrer"
                  title="Abrir demo en una nueva pestaña"
                  aria-label="Abrir demo en una nueva pestaña"
                >Demo ↗</a>
              )}
            </div>
          )}

          {data.tags?.length ? (
            <p style="margin:.25rem 0 1rem"><strong>Tecnologías:</strong> {data.tags.join(", ")}</p>
          ) : null}

          <hr style="border:none; border-top:1px solid var(--am-border); margin:12px 0" />

          <div class="prose">
            <Content />
          </div>
        </div>
      </article>

      {data.changelog?.length ? (
        <section class="section section--tight">
          <h2 class="h2">Changelog</h2>
          <ul class="stack">
            {data.changelog.map((rel) => (
              <li class="card">
                <div class="card__body">
                  <div class="card__title">
                    {rel.version} <span style="font-size:.9rem; color:#6b7280">({fmt(rel.date)})</span>
                  </div>
                  <ul class="prose-list">
                    {rel.changes.map((c) => (
                      <li><code>{c.type}</code> {c.text}</li>
                    ))}
                  </ul>
                </div>
              </li>
            ))}
          </ul>
        </section>
      ) : null}
    </div>
  </section>
</BaseLayout>
