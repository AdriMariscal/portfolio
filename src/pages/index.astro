---
// layouts & componentes
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/Hero.astro";
import ProjectCard from "../components/ProjectCard.astro";
import PostCard from "../components/PostCard.astro";

// contenido
import { getCollection } from "astro:content";
import { getFeaturedProjects, countProjects } from "../lib/content";

// Proyectos destacados
const featuredProjects = await getFeaturedProjects();

// Helper seguro para extraer la fecha como número (ms)
// - Soporta Date o string ISO
// - Si no hay fecha, devuelve 0 para mandar el post al final
function ts(entry: any): number {
  const d = entry?.data?.date;
  if (!d) return 0;
  return d instanceof Date ? d.getTime() : new Date(d).getTime() || 0;
}

// 3 últimos posts por fecha DESC (ignorando drafts y posts sin fecha)
const latestPosts = (await getCollection("blog"))
  .filter((p) => !p.data?.draft && p.data?.date)
  .sort((a, b) => ts(b) - ts(a))
  .slice(0, 3);

// Métrica de proyectos
const totalProjects = await countProjects();
---

<BaseLayout title="Inicio">
  <Hero totalProjects={totalProjects} />

  <section class="section">
    <div class="wrap">
      <h2 class="h2 section__title">Proyectos destacados</h2>
      <div class="grid grid--3" style="--stack-gap:16px">
        {featuredProjects.map((entry) => <ProjectCard entry={entry} />)}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="wrap">
      <h2 class="h2 section__title">Últimos artículos</h2>
      <div class="grid grid--3" style="--stack-gap:16px">
        {latestPosts.map((entry) => <PostCard entry={entry} />)}
      </div>
    </div>
  </section>
</BaseLayout>
