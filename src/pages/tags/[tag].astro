---
// src/pages/tags/[tag].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

// Genera una página estática por cada etiqueta encontrada en los posts
export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => data.published !== false);
  const slugs = new Set<string>();

  for (const p of posts) {
    const t = Array.isArray(p.data.tags) ? p.data.tags : [];
    for (const tag of t) {
      // Usa la misma "regla de slug" que PostCard: encodeURIComponent + toLowerCase
      slugs.add(encodeURIComponent(String(tag).toLowerCase()));
    }
  }

  return [...slugs].map((s) => ({ params: { tag: s } }));
}

// Parámetro de ruta (slug ya en minúsculas/URI-safe)
const { tag } = Astro.params;
const target = String(tag ?? '').toLowerCase();

// Carga y filtra posts por etiqueta (case-insensitive) usando la misma regla de slug
const all = await getCollection('blog', ({ data }) => data.published !== false);
const entries = all
  .filter((entry) => {
    const tags = Array.isArray(entry.data.tags) ? entry.data.tags : [];
    return tags.some(
      (t) => encodeURIComponent(String(t).toLowerCase()) === target
    );
  })
  .sort((a, b) => {
    const da = new Date(a.data.date ?? 0).getTime();
    const db = new Date(b.data.date ?? 0).getTime();
    return db - da; // más nuevos primero
  });

// 9 últimos (mismo patrón visual que el índice del blog)
const latest = entries.slice(0, 9);
const label = decodeURIComponent(target);
---

<BaseLayout title={`#${label} · Blog`}>
  <main class="section">
    <div class="wrap">
      <h1 class="h2" style="font-size:2rem;margin-bottom:18px">#{label}</h1>

      {latest.length === 0 ? (
        <p>No hay artículos con esta etiqueta todavía.</p>
      ) : (
        <div class="posts-grid">
          {latest.map((entry) => (
            <PostCard entry={entry} maxTags={4} />
          ))}
      </div>
      )}
    </div>
  </main>
</BaseLayout>
