---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostCard from '@components/PostCard.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { toSlug } from '@lib/content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tags = [...new Set(posts.flatMap((p) => p.data.tags ?? []))];

  return tags.map((tag) => ({
    params: { tag: toSlug(tag) },
    props: { tag, tagSlug: toSlug(tag) },
  }));
}

const { tag, tagSlug } = Astro.props as { tag: string; tagSlug: string };

const allPosts = await getCollection('blog');
const filtered = allPosts
  .filter((p) => (p.data.tags ?? []).some((t) => toSlug(t) === tagSlug))
  .sort(
    (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
      new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );
---

<BaseLayout title={`#${tag} — Blog`} description={`Artículos etiquetados como ${tag}`}>
  <section class="container">
    <h1 class="section__title">#{tag}</h1>
    <p class="section__lead">Artículos con la etiqueta <strong>#{tag}</strong>.</p>

    {filtered.length === 0 ? (
      <p>No hay artículos para esta etiqueta todavía.</p>
      ) : (
      <div class="grid grid--posts">
        {filtered.map((post) => (
          <PostCard entry={post} />
        ))}
      </div>
      )}
  </section>
</BaseLayout>
