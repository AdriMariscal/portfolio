---
// src/pages/blog/[slug].astro
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

// Rutas estáticas para cada post
export async function getStaticPaths() {
  const entries = await getCollection("blog");
  return entries.map((p) => ({ params: { slug: p.slug } }));
}

// Cargar el post actual
const { slug } = Astro.params;
const entry = (await getCollection("blog")).find((p) => p.slug === slug);
if (!entry) throw new Error(`Post not found: ${slug}`);

const { Content } = await entry.render();

// Utilidades mínimas para formato de fecha
const fmt = (d: Date) =>
  new Intl.DateTimeFormat("es-ES", { day: "2-digit", month: "2-digit", year: "numeric" }).format(d);
---

<BaseLayout title={entry.data.title}>
  <main class="section">
    <div class="wrap">
      <h1 class="h2" style="font-size:2rem;margin-bottom:12px">{entry.data.title}</h1>
      <p style="margin:0 0 12px 0;opacity:.75">{fmt(entry.data.date)}</p>

      <!-- Botón Volver: fallback seguro a /blog; el script lo mejora con referrer -->
      <div style="margin: 8px 0 16px 0">
        <a id="back-link" class="btn btn-secondary" href="/blog">← Volver</a>
              </div>

      <article class="prose">
            <Content />
      </article>
    </div>
  </main>

  <!-- Mejora progresiva del botón "Volver" en cliente -->
  <script>
    (() => {
      const back = document.getElementById('back-link');
      if (!back) return;

      const ref = document.referrer;
      let canUseHistory = false;

      try {
        const url = ref ? new URL(ref, location.href) : null;
        const sameOrigin = !!url && url.origin === location.origin;

        // Permitimos volver a Home, Blog o una página de etiquetas
        const allowed =
          sameOrigin &&
          (url.pathname === '/' ||
           url.pathname === '/blog' ||
           url.pathname === '/blog/' ||
           url.pathname.startsWith('/blog/tags/'));

        if (allowed) {
          back.setAttribute('href', url.href);
          canUseHistory = true;
        }
      } catch {
        /* ignore */
      }

      back.addEventListener('click', (e) => {
        if (canUseHistory && window.history.length > 1) {
          e.preventDefault();
          window.history.back();
        }
      });
    })();
  </script>
</BaseLayout>
