---
// src/components/ProjectCard.astro
import type { CollectionEntry } from "astro:content";

type Link = { href: string; label: string };

type WithEntry = {
  entry: CollectionEntry<"projects">;
  withLinks?: boolean;
};

type WithProps = {
  title: string;
  description?: string;
  status?: string;
  tags?: string[];
  links?: Link[];
  withLinks?: boolean;
};

const props = Astro.props as WithEntry | WithProps;

const title =
  "entry" in props ? props.entry.data.title : props.title;

const description =
  "entry" in props ? props.entry.data.description : props.description;

const status =
  "entry" in props ? props.entry.data.status : props.status;

const allTags: string[] =
  "entry" in props ? (props.entry.data.tags ?? []) : (props.tags ?? []);

const links: Link[] =
  "entry" in props ? (props.entry.data.links ?? []) : (props.links ?? []);

const withLinks = props.withLinks ?? true;

// HREF de la ficha (solo si viene desde colección)
const href =
  "entry" in props ? `/projects/${props.entry.slug}/` : undefined;

// Máximo de etiquetas visibles
const MAX_TAGS = 6;
const displayTags = allTags.slice(0, MAX_TAGS);

const toExternal = (url: string) => url.startsWith("http");
const slugifyTag = (t: string) =>
  t
    .toLowerCase()
    .trim()
    .normalize("NFD")
    .replace(/\p{Diacritic}/gu, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
---

<article class="card project-card">
  <div class="card__body">
    <h3 class="card__title">
      {href ? (
        <a
          href={href}
          class="card__title-link"
          aria-label={`Abrir ficha del proyecto: ${title}`}
        >
          {title}
        </a>
      ) : (
        title
      )}
    </h3>

    {description && <p class="card__excerpt">{description}</p>}

    {withLinks && links.length > 0 && (
      <ul class="links" aria-label="Enlaces del proyecto">
        {links.map((l) => (
            <li>
            <a
              class="btn btn--sm btn--secondary"
              href={l.href}
              target={toExternal(l.href) ? "_blank" : undefined}
              rel={toExternal(l.href) ? "noopener noreferrer" : undefined}
            >
              {l.label}
            </a>
            </li>
        ))}
        </ul>
    )}

    {displayTags.length > 0 && (
          <ul class="taglist" aria-label="Etiquetas">
        {displayTags.map((t) => (
              <li>
            <a class="tag" href={`/blog/tags/${slugifyTag(t)}/`}>#{t}</a>
              </li>
            ))}
          </ul>
    )}
  </div>
</article>

<style>
  .links,
  .taglist {
    display: flex;
    gap: 12px;
    list-style: none;
    margin: 12px 0 0;
    padding: 0;
    flex-wrap: wrap;
  }

  .card__title-link {
    display: inline-block;
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: border-color .15s ease, color .15s ease;
  }
  .card__title-link:hover { border-color: currentColor; }
  .card__title-link:focus-visible {
    outline: 3px solid rgba(11,31,59,.25);
    outline-offset: 2px;
    border-color: transparent;
    border-radius: 6px;
  }
</style>
